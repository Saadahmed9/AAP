---
- name: Provision HCP cluster
  hosts: localhost
  

  tasks:
    - name: Create temporary directory with write access for playbook user
      file:
        path: /tmp/hcp_install
        state: directory
        mode: 0755  # Allows user to read, write, execute, and group/others can only read and execute

    - name: Download HCP archive to temporary directory
      uri:
        url: https://hcp-cli-download-multicluster-engine.apps.mgm2.tmetse.bos2.lab/linux/amd64/hcp.tar.gz
        dest: /tmp/hcp_install/hcp.tar.gz
        mode: 0644
        validate_certs: no 

    - name: Unpack HCP archive using unarchive module
      ansible.builtin.unarchive:
        # Set src to the downloaded archive path
        src: /tmp/hcp_install/hcp.tar.gz
        # Set dest to the directory where you want to unpack (contents will be placed here)
        dest: /tmp/hcp_install 
    
    - name: Make HCP binary executable
      file:
        path: /tmp/hcp_install/hcp
        mode: +x
        owner: 
        group: 
    - name: Export cluster variables
      set_fact:
        CLUSTER_NAME: hcp-test-app
        MEM: 16Gi
        CPU: 8
        WORKER_COUNT: 1
        ETCD_STORAGE: ocs-storagecluster-ceph-rbd
        OCP_RELEASE: 4.14.11-x86_64
        PULL_SECRET: "{{ lookup('env', 'PULL_SECRET') }}"
    - name: Print environment variable hy
      debug:
          msg: "Secret key content: {{ PULL_SECRET }}"
    - name: Create KubeVirt cluster
      command: /tmp/hcp_install/hcp create cluster kubevirt \
               --name "{{CLUSTER_NAME}}" \
               --node-pool-replicas=1 \
               --memory "{{MEM}}" \
               --cores "{{CPU}}" \
               --release-image=quay.io/openshift-ease:4.14.11-x86_64 \
               --pull-secret= {"auths":{"cloud.openshift.com":{"auth":"b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K3JobnNhbnNhdHNpYTFwMmJzNnUyY3Fzbmx4a3VhaG5ycWJtbGRldzpXSDNNRVVGNjBTWkhPWTIyNFA0VDBYMzY5WFU3SFhETjVGQVlYQTJaRDEySTNET00xWTNEUjFBMEVDVE9VMVkz","email":"nsatsia@redhat.com"},"quay.io":{"auth":"b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K3JobnNhbnNhdHNpYTFwMmJzNnUyY3Fzbmx4a3VhaG5ycWJtbGRldzpXSDNNRVVGNjBTWkhPWTIyNFA0VDBYMzY5WFU3SFhETjVGQVlYQTJaRDEySTNET00xWTNEUjFBMEVDVE9VMVkz","email":"nsatsia@redhat.com"},"registry.connect.redhat.com":{"auth":"ODE2NDgyOXx1aGMtMVAyQnM2dTJDUVNuTFhrdUFIblJxQk1sZGVXOmV5SmhiR2NpT2lKU1V6VXhNaUo5LmV5SnpkV0lpT2lJNE4yTXdaRGczWTJRek5HSTBNV0V6T1dFd1l6SXpabVZpWVRWbFpHWmxOeUo5Llc3SnZoN0tlRmwtM280MmhmU2RNTEFQWHhmek5ZSUFjeUxtNzg2V3Y5VmFCeVk3S3h0WGZibDN6RWRQSko3dG1pZWliZGlvWUxPS2tnVDdaZXh2V2wzYVBaOW1HWWw2Q2Rtai0wQ2hyUVpzb2QzU3NxRjgzNlhtUFpXbklMTmRFSWZiUmt3TUl4ell4T2UzTmRQdF9CZ3c2cy1ucjJRaDRIYnVpYlRBclhxZExSRjlKUDNESWVKOHpPS0VUdG54ZXZPVHZJTmQ3bENlS2VEX3RUekw5el9rUHBrR2hGak5sdjFmdmpid2Rkc0pWMnlFdUVSbUxlam45M0VEVFBoLUpta0xaR3NRbWtNa1puYi15eDBSVWliMjVGOGhIeGVJVjZmUU92enNERHdlRnl2aDNSYVlMLWtFSGs2NVdhSXNHbW8tNHBJQ254NHRRWXFac2lWN1hVQzc0c1FzMVNhRWJjdHd4YTFQR240UUx0MkNaZ3NNNndWay1RVVA5cm9IaXlqUl9VREVURjJuNmxkSERYcU8zOWVYSGplSzRCSWNQM1hRNGVtZEhsRU5NUzJrM09VNV8tVGg0dVRYRV9GaWxCZ0IzSFJqX3ZIUHZzUmdSNGJjck9nS3BRd3hDMFY4NlRnbnZqeHNFSk93Q1M5WkE0V2NrVmJsT0hBNzZ1UVc3VkpRaFN1U2lmZjJkRkNMWXZVNXM4eG9ReEtIMWFMSnpra0k1MkxzLVhzYV8tV0dIcHcwLUV4WFNRNGw3azYzUGxiZWZSTjNTLVZiSjJOT2FGNXU4NmV1TUtFVDExSGRPLURCVFRLbnk1RGlTRUZEa0NldGpoYkxsYzNaeFRRTEI2S0lmWjRkSktncEJ5dlN3NzFER0JSNzRIWExJc0lBMlVMXzdCT0p6RzZR","email":"nsatsia@redhat.com"},"registry.redhat.io":{"auth":"ODE2NDgyOXx1aGMtMVAyQnM2dTJDUVNuTFhrdUFIblJxQk1sZGVXOmV5SmhiR2NpT2lKU1V6VXhNaUo5LmV5SnpkV0lpT2lJNE4yTXdaRGczWTJRek5HSTBNV0V6T1dFd1l6SXpabVZpWVRWbFpHWmxOeUo5Llc3SnZoN0tlRmwtM280MmhmU2RNTEFQWHhmek5ZSUFjeUxtNzg2V3Y5VmFCeVk3S3h0WGZibDN6RWRQSko3dG1pZWliZGlvWUxPS2tnVDdaZXh2V2wzYVBaOW1HWWw2Q2Rtai0wQ2hyUVpzb2QzU3NxRjgzNlhtUFpXbklMTmRFSWZiUmt3TUl4ell4T2UzTmRQdF9CZ3c2cy1ucjJRaDRIYnVpYlRBclhxZExSRjlKUDNESWVKOHpPS0VUdG54ZXZPVHZJTmQ3bENlS2VEX3RUekw5el9rUHBrR2hGak5sdjFmdmpid2Rkc0pWMnlFdUVSbUxlam45M0VEVFBoLUpta0xaR3NRbWtNa1puYi15eDBSVWliMjVGOGhIeGVJVjZmUU92enNERHdlRnl2aDNSYVlMLWtFSGs2NVdhSXNHbW8tNHBJQ254NHRRWXFac2lWN1hVQzc0c1FzMVNhRWJjdHd4YTFQR240UUx0MkNaZ3NNNndWay1RVVA5cm9IaXlqUl9VREVURjJuNmxkSERYcU8zOWVYSGplSzRCSWNQM1hRNGVtZEhsRU5NUzJrM09VNV8tVGg0dVRYRV9GaWxCZ0IzSFJqX3ZIUHZzUmdSNGJjck9nS3BRd3hDMFY4NlRnbnZqeHNFSk93Q1M5WkE0V2NrVmJsT0hBNzZ1UVc3VkpRaFN1U2lmZjJkRkNMWXZVNXM4eG9ReEtIMWFMSnpra0k1MkxzLVhzYV8tV0dIcHcwLUV4WFNRNGw3azYzUGxiZWZSTjNTLVZiSjJOT2FGNXU4NmV1TUtFVDExSGRPLURCVFRLbnk1RGlTRUZEa0NldGpoYkxsYzNaeFRRTEI2S0lmWjRkSktncEJ5dlN3NzFER0JSNzRIWExJc0lBMlVMXzdCT0p6RzZR","email":"nsatsia@redhat.com"},"lab-registry.mgm2.tmetse.bos2.lab":{"auth":"Z2l0b3BzX21nbXQ6UmVkaGF0MDE=","email":""},"lab-registry.mgm2.tmetse.bos2.lab/gitops_mgmt":{"auth":"Z2l0b3BzX21nbXQ6UmVkaGF0MDE=","email":""},"lab-registry.mgm2.tmetse.bos2.lab/cache-quayio":{"auth":"Z2l0b3BzX21nbXQ6UmVkaGF0MDE=","email":""},"lab-registry.mgm2.tmetse.bos2.lab/cache-registryredhatio":{"auth":"Z2l0b3BzX21nbXQ6UmVkaGF0MDE=","email":""},"lab-registry.mgm2.tmetse.bos2.lab/cache-registryconnectredhatcom":{"auth":"Z2l0b3BzX21nbXQ6UmVkaGF0MDE=","email":""}}}
 \ 
               --etcd-storage-class= ocs-storagecluster-ceph-rbd
      
  #- name: Verify HCP installation (using full path)
     # command: /tmp/hcp_install/hcp --version
      #register: hcp_version
    # Optional task to verify installation

     # Optional task to display the HCP version 
